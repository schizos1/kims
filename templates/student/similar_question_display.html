{% extends "student/layout.html" %}

{% block title %}유사 문제 연습 - {{ original_question.concept.name }}{% endblock %}

{% block head_extra %}
<style>
    /* ... (기존 question-box, answer-box 등 스타일 유지) ... */
    .question-box { white-space: pre-wrap; line-height: 1.7; background-color: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6; }
    .answer-box { padding: 10px; border-radius: 5px; }
    .correct-answer-display { background-color: #d1e7dd; border-color: #badbcc; }
    .user-answer-correct { background-color: #d1e7dd; border-color: #badbcc; }
    .user-answer-incorrect { background-color: #f8d7da; border-color: #f5c2c7; }

    /* ★★★ 정답/오답 애니메이션 CSS 추가 ★★★ */
    @keyframes sparkle { /* 정답 시 반짝이는 효과 */
        0% { box-shadow: 0 0 5px #28a745; transform: scale(1); }
        50% { box-shadow: 0 0 20px #28a745, 0 0 30px #28a745; transform: scale(1.05); }
        100% { box-shadow: 0 0 5px #28a745; transform: scale(1); }
    }
    @keyframes shake { /* 오답 시 흔들리는 효과 */
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
        20%, 40%, 60%, 80% { transform: translateX(8px); }
    }
    .feedback-correct-animation {
        animation: sparkle 0.8s ease-in-out;
    }
    .feedback-incorrect-animation {
        animation: shake 0.5s ease-in-out;
    }
</style>
{% endblock %}

{% block content %}
    {# ... (기존 navbar 및 breadcrumb, 원래 문제 표시 부분 등) ... #}
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">과목 목록</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('view_subject_concepts', subject_id=original_question.concept.subject.id) }}">{{ original_question.concept.subject.name }}</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('start_concept_test', concept_id=original_question.concept.id) }}">{{ original_question.concept.name }} 테스트</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('view_test_results', concept_id=original_question.concept.id) }}">결과</a></li>
            <li class="breadcrumb-item active" aria-current="page">유사 문제</li>
        </ol>
    </nav>

    <h2 class="mb-3">'{{ original_question.concept.name }}' 개념 - 유사 문제 연습</h2>

    <div class="card mb-4">
        <div class="card-header"><strong>원래 문제 (참고용)</strong></div>
        <div class="card-body">
            <div class="question-box">{{ original_question.content }}</div>
            <p class="mt-2"><strong>원래 정답:</strong> {{ original_question.answer }}</p>
        </div>
    </div>

    <div class="card border-primary">
        <div class="card-header bg-primary text-white"><strong>✨ AI가 생성한 새로운 유사 문제 ✨</strong></div>
        <div class="card-body">
            <div class="question-box fs-5 mb-3">{{ new_question_text }}</div>

            {% if feedback_result %}
                <script>
                    document.addEventListener('DOMContentLoaded', function() { 
                        if (typeof playSound === "function") { 
                            {% if feedback_result.is_correct %}
                                playSound('correct.mp3');
                            {% else %}
                                playSound('incorrect.mp3');
                            {% endif %}
                        }
                    });
                </script>

                {# ★★★ 애니메이션 클래스 추가 ★★★ #}
                <div class="mb-3 {% if feedback_result.is_correct %}feedback-correct-animation{% else %}feedback-incorrect-animation{% endif %}">
                    <p class="mb-1"><strong>내가 제출한 답:</strong></p>
                    <div class="answer-box {% if feedback_result.is_correct %}user-answer-correct{% else %}user-answer-incorrect{% endif %}">
                        {{ feedback_result.submitted if feedback_result.submitted else '답변 안 함' }}
                    </div>
                </div>
                {% if feedback_result.is_correct %}
                    <div class="alert alert-success fw-bold">🎉 정답입니다! 잘하셨어요! 🎉</div>
                {% else %}
                    <div class="alert alert-danger fw-bold">😟 아쉽지만 틀렸어요.</div>
                    <p class="mb-1"><strong>정답:</strong></p>
                    <div class="answer-box correct-answer-display">{{ feedback_result.correct }}</div>
                {% endif %}
                <hr>
                <a href="{{ url_for('generate_similar_question_page', original_question_id=original_question.id) }}" class="btn btn-warning mt-2">🔄 다른 유사 문제 풀어보기</a>

            {% else %}
                <form action="{{ url_for('generate_similar_question_page', original_question_id=original_question.id) }}" method="POST">
                    <div class="mb-3">
                        <label for="submitted_answer" class="form-label"><strong>정답 입력:</strong></label>
                        <input type="text" class="form-control" id="submitted_answer" name="submitted_answer" required>
                    </div>
                    <button type="submit" class="btn btn-success">답변 제출</button>
                </form>
            {% endif %}
        </div>
    </div>

    <div class="mt-4">
        <a href="{{ url_for('view_test_results', concept_id=original_question.concept.id) }}" class="btn btn-secondary">&laquo; 테스트 결과로 돌아가기</a>
    </div>
{% endblock %}

{% block scripts_extra %}
{# 이 페이지는 layout.html의 playSound 함수를 사용하므로, 별도 스크립트 블록이 필요 없습니다.
   만약 이 페이지에서만 필요한 추가 JS가 있다면 여기에 작성합니다. #}
{% endblock %}