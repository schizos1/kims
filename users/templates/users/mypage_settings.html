{# users/templates/users/mypage_settings.html #}
{% extends 'base.html' %}
{% load static %}

{% block title %}{{ userprofile.nickname|default:user.username }}λ‹μ μ„¤μ •{% endblock %}

{% block content %}
<div class="container mt-4 mb-5">
    <style>
        /* ... (κΈ°μ΅΄ μ¤νƒ€μΌμ€ κ·Έλ€λ΅) ... */
        .settings-card { background-color: #fff; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); margin-bottom: 30px; }
        .settings-card h3 { color: #4A90E2; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { font-weight: bold; display: block; margin-bottom: 8px; }
        .form-control, .form-control-select, .form-control-number { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        .btn-submit-action { /* λ²„νΌ ν΄λμ¤ μ΄λ¦„ λ³€κ²½ λ° μ¤νƒ€μΌ ν†µμΌ */
            background-color: #5cb85c; color: white; padding: 10px 20px; 
            border: none; border-radius: 8px; cursor: pointer; font-size: 1em; margin-top:10px;
        }
        .btn-submit-action:hover { background-color: #4cae4c; }
        .current-info { font-size: 0.9em; color: #777; margin-top: 5px; }

        .mascot-selection-gallery { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px; padding: 10px; background-color: #f9f9f9; border-radius: 8px; }
        .mascot-option label { border: 2px solid transparent; border-radius: 10px; padding: 10px; text-align: center; cursor: pointer; transition: all 0.2s; display: block; }
        .mascot-option img { width: 70px; height: 70px; object-fit: contain; margin-bottom: 5px; border-radius: 8px; background-color: #fff; padding:3px; border: 1px solid #eee;}
        .mascot-option span { font-size: 0.85em; display: block; color: #555; }
        .mascot-option input[type="radio"] { opacity: 0; position: absolute; width: 0; height: 0; } 
        .mascot-option input[type="radio"]:checked + .mascot-option-display { border-color: #4A90E2; box-shadow: 0 0 12px rgba(74, 144, 226, 0.6); transform: scale(1.05); }
        .mascot-option-display { border: 2px solid #eee; border-radius: 10px; padding: 10px; transition: all 0.2s; }
        .mascot-option-display:hover { border-color: #90caf9; box-shadow: 0 0 8px rgba(144, 202, 249, 0.4); }

        .transaction-list { list-style-type: none; padding-left: 0; }
        .transaction-list li { padding: 10px; border-bottom: 1px solid #eee; }
        .transaction-list li:last-child { border-bottom: none; }
        .transaction-points-deducted { color: red; font-weight: bold;}
        .transaction-points-earned { color: green; font-weight: bold;}
    </style>

    <h2 class="text-center mb-4">β™οΈ {{ userprofile.nickname|default:user.username }}λ‹ μ„¤μ •</h2>

    {% if messages %}
        {% for message in messages %}
            <div class="alert {% if message.tags == 'success' %}alert-success{% elif message.tags == 'error' %}alert-danger{% else %}alert-info{% endif %}" role="alert">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    {# --- ν”„λ΅ν•„, λ§μ¤μ½”νΈ, ν…λ§ μ„¤μ • νΌ --- #}
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="update_profile_settings"> {# μ‘μ—… κµ¬λ¶„μ© hidden input #}

        <div class="settings-card">
            <h3>π‘¤ ν”„λ΅ν•„ λ° λ§μ¤μ½”νΈ</h3>
            <div class="form-group">
                <label for="nickname">λ‹‰λ„¤μ„ (μµλ€ 20μ):</label>
                <input type="text" name="nickname" id="nickname" value="{{ userprofile.nickname|default:user.username }}" class="form-control" maxlength="20">
            </div>
            <div class="form-group">
                <label for="mascot_name">λ§μ¤μ½”νΈ μ• μΉ­ (μµλ€ 20μ):</label>
                <input type="text" name="mascot_name" id="mascot_name" value="{{ userprofile.mascot_name|default:'' }}" class="form-control" placeholder="μ: μ©κ°ν• λΌμ΄μ–Έ" maxlength="20">
            </div>
            <div class="form-group">
                <label>λ§μ¤μ½”νΈ μ„ νƒ:</label>
                {% if userprofile.selected_mascot %}
                    <p class="current-info">ν„μ¬ μ„ νƒ: <strong>{{ userprofile.selected_mascot.name }}</strong>
                        <img src="{{ userprofile.selected_mascot.image.url }}" alt="{{ userprofile.selected_mascot.name }}" style="width:24px; height:24px; vertical-align:middle; margin-left:5px; border-radius:3px;">
                    </p>
                {% else %}
                    <p class="current-info">μ„ νƒλ λ§μ¤μ½”νΈκ°€ μ—†μµλ‹λ‹¤.</p>
                {% endif %}
                <div class="mascot-selection-gallery">
                    <div class="mascot-option">
                        <input type="radio" name="gallery_mascot_select" value="none" id="mascot_none" {% if not userprofile.selected_mascot %}checked{% endif %}>
                        <label for="mascot_none" class="mascot-option-display" style="width: 82px; height: 102px; display:flex; align-items:center; justify-content:center; font-size:0.9em; color:#777;">μ„ νƒ μ•ν•¨</label>
                    </div>
                    {% for mascot_obj in gallery_mascots %}
                    <div class="mascot-option">
                        <input type="radio" name="gallery_mascot_select" value="{{ mascot_obj.id }}" id="mascot_{{ mascot_obj.id }}" {% if userprofile.selected_mascot and userprofile.selected_mascot.id == mascot_obj.id %}checked{% endif %}>
                        <label for="mascot_{{ mascot_obj.id }}" class="mascot-option-display">
                            <img src="{{ mascot_obj.image.url }}" alt="{{ mascot_obj.name }}">
                            <span>{{ mascot_obj.name }}</span>
                        </label>
                    </div>
                    {% empty %}
                    <p>μ„ νƒ κ°€λ¥ν• λ§μ¤μ½”νΈκ°€ μ—†μµλ‹λ‹¤.</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        {# --- ν…λ§ μ„¤μ • μΉ΄λ“ (μ‚¬μ©μ μ”μ²­μ— λ”°λΌ μ μ§€) --- #}
        <div class="settings-card">
            <h3>π¨ ν…λ§ μ„¤μ •</h3>
            <div class="form-group">
                <label for="select_theme">ν…λ§ μ„ νƒ:</label>
                <select name="select_theme" id="select_theme" class="form-control-select">
                    <option value="" {% if not userprofile.selected_theme %}selected{% endif %}>ν…λ§ μ„ νƒ μ•ν•¨</option>
                    {% for theme_obj in themes %}
                        <option value="{{ theme_obj.id }}" {% if userprofile.selected_theme and userprofile.selected_theme.id == theme_obj.id %}selected{% endif %}>
                            {{ theme_obj.display_name }}
                        </option>
                    {% endfor %}
                </select>
                {% if userprofile.selected_theme %}
                <p class="current-info mt-2">ν„μ¬ μ μ©λ ν…λ§: <strong>{{ userprofile.selected_theme.display_name }}</strong></p>
                {% endif %}
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 10px; margin-bottom: 30px;">
            <button type="submit" class="btn-submit-action">ν”„λ΅ν•„/λ§μ¤μ½”νΈ/ν…λ§ μ €μ¥</button>
        </div>
    </form> {# ν”„λ΅ν•„/λ§μ¤μ½”νΈ/ν…λ§ μ„¤μ • νΌ λ #}


    {# --- ν¬μΈνΈ μ‚¬μ© μ‹ μ²­ (μ©λ) --- #}
    <div class="settings-card">
        <h3>π’° ν¬μΈνΈ μ‚¬μ© μ‹ μ²­ (μ©λμΌλ΅ μ „ν™)</h3>
        <p class="current-info">ν„μ¬ μ‚¬μ© κ°€λ¥ ν¬μΈνΈ: <strong>{{ available_points|default:0 }} P</strong></p>
        
        <form method="post" class="mt-3">
            {% csrf_token %}
            <input type="hidden" name="action" value="request_allowance"> {# μ‘μ—… κµ¬λ¶„μ© hidden input #}
            <div class="form-group">
                <label for="points_to_use">μ‚¬μ©ν•  ν¬μΈνΈ:</label>
                <input type="number" name="points_to_use" id="points_to_use" class="form-control-number" placeholder="μ: 1000" min="1" required>
            </div>
            <button type="submit" class="btn-submit-action" style="background-color: #007bff;">μ©λ μ‹ μ²­ν•κΈ°</button> {# λ²„νΌ μƒ‰μƒ λ³€κ²½ #}
        </form>
    </div>

    {# --- ν¬μΈνΈ μ‚¬μ© λ‚΄μ—­ --- #}
    <div class="settings-card">
        <h3>π“ μµκ·Ό ν¬μΈνΈ κ±°λ λ‚΄μ—­ (μµλ€ 10κ±΄)</h3>
        {% if point_transactions %}
            <ul class="transaction-list">
                {% for transaction in point_transactions %}
                    <li>
                        <span style="color: #888; font-size: 0.9em;">{{ transaction.timestamp|date:"Y.m.d H:i" }}</span> - 
                        <strong>{{ transaction.get_transaction_type_display }}</strong>
                        {% if transaction.description %}({{ transaction.description }}){% endif %}: 
                        <span class="{% if transaction.points_changed < 0 %}transaction-points-deducted{% else %}transaction-points-earned{% endif %}">
                            {{ transaction.points_changed }}P
                        </span>
                    </li>
                {% empty %}
                    <p>ν¬μΈνΈ κ±°λ λ‚΄μ—­μ΄ μ—†μµλ‹λ‹¤.</p>
                {% endfor %}
            </ul>
        {% else %}
            <p>ν¬μΈνΈ κ±°λ λ‚΄μ—­μ΄ μ—†μµλ‹λ‹¤.</p>
        {% endif %}
    </div>
</div>
{% endblock %}