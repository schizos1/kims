{# minigame/templates/minigame/eat_food_entry.html #}
{% extends 'base.html' %} 
{% load static %}

{% block title %}ë¨¹ì´ ë¨¹ê¸° ê²Œì„ - {{ game_mode|capfirst }} ëª¨ë“œ{% endblock %}

{% block extra_head %}
    {# eat_food ê²Œì„ ì „ìš© CSS (ê¸°ì¡´ eat_food.css ë‚´ìš©) #}
    <link rel="stylesheet" href="{% static 'minigame/css/eat_food.css' %}"> 
    <style>
        /* ì¶”ê°€ì ì¸ í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ì´ ìˆë‹¤ë©´ ì—¬ê¸°ì— */
        #chat-area { margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 5px; max-height: 150px; overflow-y: auto; }
        #chat-messages p { margin: 2px 0; font-size: 0.9em; }
        #chat-input-group { display: flex; margin-top: 5px; }
        #chat-input-group input { flex-grow: 1; margin-right: 5px; }
    </style>
{% endblock %}

{% block content %}
    {# ê²Œì„ UI ìš”ì†Œë“¤ (ìº”ë²„ìŠ¤, ì ìˆ˜íŒ, ë²„íŠ¼ ë“±) #}
    <div id="game-container">
        <canvas id="canvas" width="1280" height="720"></canvas>
        <div id="ui-layer">
            <div id="score-board">ì ìˆ˜: <span id="score-num">0</span></div>
            <div id="food-left">ë‚¨ì€ ìŒì‹: <span id="foodleft-num">30</span></div>
            <div id="progress-bar-container"><div id="progress-bar-fill"></div></div>
        </div>
        <div id="user-ui">
            <label for="username">ì´ë¦„:</label>
            {# ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì´ë¦„ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì‚¬ìš© #}
            <input type="text" id="username" value="{{ user_username|default:'ìµëª…ê²Œì´ë¨¸' }}"> 
            <button id="actual-start-button" disabled>ê²Œì„ ì‹œì‘ ëŒ€ê¸° ì¤‘...</button> 
        </div>
        <div id="system-msg">ì—ì…‹ ë¡œë”© ì¤‘...</div>
        
        <div id="result-popup" style="display:none;">
            <div id="result-content"></div>
            <button id="close-result-button">ë‹¤ì‹œí•˜ê¸° / ë‚˜ê°€ê¸°</button>
        </div>

        {# ë©€í‹°í”Œë ˆì´ì–´ ëª¨ë“œì¼ ë•Œë§Œ ë³´ì´ëŠ” ì±„íŒ…ì°½ #}
        {% if game_mode == 'multi' %}
        <div id="chat-area">
            <div id="chat-messages"></div>
            <div id="chat-input-group">
                <input type="text" id="chat-input" placeholder="ì±„íŒ… ë©”ì‹œì§€...">
                <button id="chat-send-button">ì „ì†¡</button>
            </div>
        </div>
        {% endif %}
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        // Django ì»¨í…ìŠ¤íŠ¸ ë³€ìˆ˜ë¥¼ JavaScript ë³€ìˆ˜ë¡œ ì „ë‹¬
        const GAME_MODE = "{{ game_mode|escapejs }}";
        const ROOM_ID = "{{ room_id|escapejs|default:'' }}"; // room_idê°€ ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´
        const USER_NAME_FROM_DJANGO = "{{ user_username|escapejs|default:'' }}"; 
    </script>

     <script src="{% static 'minigame/js/eat_food/eat_food_common.js' %}"></script>
    
    {% if game_mode == 'single' %}
        <script src="{% static 'minigame/js/eat_food/eat_food_single.js' %}"></script>
    {% elif game_mode == 'multi' %}
        <script src="{% static 'minigame/js/eat_food/eat_food_multi.js' %}"></script>
    {% endif %}
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const startButton = document.getElementById("actual-start-button");
            const usernameField = document.getElementById('username');
            const gameCanvas = document.getElementById('canvas'); // canvas ê°€ì ¸ì˜¤ê¸°

            if (USER_NAME_FROM_DJANGO && usernameField) {
                usernameField.value = USER_NAME_FROM_DJANGO;
            }
            
            if (startButton) {
                // ... (ê¸°ì¡´ ì‹œì‘ ë²„íŠ¼ í™œì„±í™” ë¡œì§ì€ ë™ì¼) ...
                const ensureAssetsLoadedInterval = setInterval(function() {
                    console.log("DEBUG_ENTRY_HTML: Checking window.assetsLoaded - Value: ", window.assetsLoaded);
                    if (window.assetsLoaded) { 
                        console.log("DEBUG_ENTRY_HTML: window.assetsLoaded is true. Enabling button and setting onclick.");
                        startButton.disabled = false;
                        startButton.textContent = "ê²Œì„ ì‹œì‘!";
                        startButton.onclick = function() {
                            if (GAME_MODE === 'single' && typeof window.startGame_single === 'function') {
                                console.log("DEBUG_ENTRY_HTML: Calling window.startGame_single()");
                                window.startGame_single();
                            } else if (GAME_MODE === 'multi' && typeof window.startGame_multi === 'function') {
                                if (ROOM_ID) {
                                    console.log("DEBUG_ENTRY_HTML: Calling window.startGame_multi() with ROOM_ID:", ROOM_ID);
                                    window.startGame_multi(ROOM_ID);
                                } else { /* ... */ }
                            } else { /* ... */ }
                        };
                        clearInterval(ensureAssetsLoadedInterval);

                        // ğŸ‘‡ ê²Œì„ ì‹œì‘ í›„ ë˜ëŠ” ì—ì…‹ ë¡œë“œ ì™„ë£Œ í›„ ë§ˆìš°ìŠ¤ ì´ë™ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                        if (gameCanvas && GAME_MODE === 'single' && typeof window.onPlayerMove_single === 'function') {
                            console.log("DEBUG_ENTRY_HTML: Adding mousemove listener for Single Player.");
                            gameCanvas.addEventListener("mousemove", window.onPlayerMove_single);
                        } else if (gameCanvas && GAME_MODE === 'multi' && typeof window.onPlayerMove_multi === 'function') {
                            // console.log("DEBUG_ENTRY_HTML: Adding mousemove listener for Multi Player.");
                            // gameCanvas.addEventListener("mousemove", window.onPlayerMove_multi); // ë©€í‹°ìš©ë„ ë™ì¼í•˜ê²Œ ì¶”ê°€
                        }

                    }
                }, 100);
            }
            // ... (closeResult ë²„íŠ¼ ë¡œì§) ...
        });
    </script>
{% endblock %}