{% extends "admin/layout.html" %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('admin.manage_subjects') }}">과목 관리</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('admin.manage_concepts', subject_id=question.concept.subject.id) }}">{{ question.concept.subject.name }}</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('admin.manage_questions', concept_id=question.concept.id) }}">{{ question.concept.name }} - 문제 관리</a></li>
        <li class="breadcrumb-item active" aria-current="page">문제 ID: {{ question.id }} 수정</li>
    </ol>
</nav>

<h2 class="mb-4">문제 수정 (ID: {{ question.id }})</h2>

<form method="POST" action="{{ url_for('admin.edit_question', question_id=question.id) }}" enctype="multipart/form-data">
    <div class="card">
        <div class="card-body">
            {# 문제 내용 #}
            <div class="mb-3">
                <label for="content" class="form-label"><strong>문제 내용 <span class="text-danger">*</span></strong></label>
                <textarea class="form-control" id="content" name="content" rows="4" required>{{ question.content }}</textarea>
            </div>

            {# 문제 본문 이미지 #}
            <div class="mb-3">
                <label for="image_filename" class="form-label">문제 본문 이미지</label>
                {% if question.image_filename %}
                <div class="mb-2">
                    <img src="{{ url_for('static', filename='uploads/questions/' + question.image_filename) }}" alt="현재 문제 이미지" style="max-width: 200px; max-height: 150px; border:1px solid #ddd; padding:5px;">
                    <div class="form-check mt-1">
                        <input class="form-check-input" type="checkbox" value="yes" id="delete_image_filename" name="delete_image_filename">
                        <label class="form-check-label" for="delete_image_filename">
                            <small>기존 본문 이미지 삭제</small>
                        </label>
                    </div>
                </div>
                {% endif %}
                <input class="form-control" type="file" id="image_filename" name="image_filename" accept="image/png, image/jpeg, image/gif">
                <small class="form-text text-muted">새 이미지를 업로드하면 기존 이미지는 삭제됩니다. 이미지만 삭제하려면 위 체크박스를 선택하세요.</small>
            </div>
            <hr>

            {# 문제 유형 #}
            <div class="mb-3">
                <label for="question_type" class="form-label"><strong>문제 유형 <span class="text-danger">*</span></strong></label>
                <select class="form-select" id="question_type" name="question_type" required>
                    <option value="multiple_choice" {% if question.question_type == 'multiple_choice' %}selected{% endif %}>객관식 (4지선다)</option>
                    <option value="short_answer" {% if question.question_type == 'short_answer' %}selected{% endif %}>주관식 단답형</option>
                </select>
            </div>

            {# 객관식 보기 입력 #}
            <h5 class="mt-4">객관식 보기 (문제 유형이 객관식일 경우)</h5>
            {% for i in [1,2,3,4] %}
                {% set option_text_val = question['option' ~ i] %}
                {% set option_img_val = question['option' ~ i ~ '_img'] %}
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="option{{i}}" class="form-label">보기 {{i}} 텍스트</label>
                    <input type="text" class="form-control" id="option{{i}}" name="option{{i}}" value="{{ option_text_val if option_text_val else '' }}" placeholder="객관식 보기 {{i}} 내용">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="option{{i}}_img" class="form-label">보기 {{i}} 이미지</label>
                    {% if option_img_val %}
                    <div class="mb-2">
                        <img src="{{ url_for('static', filename='uploads/questions/' + option_img_val) }}" alt="현재 보기 {{i}} 이미지" style="max-width: 100px; max-height: 75px; border:1px solid #ddd; padding:3px;">
                        <div class="form-check mt-1 form-check-inline">
                            <input class="form-check-input" type="checkbox" value="yes" id="delete_option{{i}}_img" name="delete_option{{i}}_img">
                            <label class="form-check-label" for="delete_option{{i}}_img">
                                <small>삭제</small>
                            </label>
                        </div>
                    </div>
                    {% endif %}
                    <input class="form-control form-control-sm" type="file" id="option{{i}}_img" name="option{{i}}_img" accept="image/png, image/jpeg, image/gif">
                    <small class="form-text text-muted">새 이미지 업로드 시 기존 이미지는 자동 삭제됩니다.</small>
                </div>
            </div>
            {% endfor %}
            <hr>

            {# 정답 #}
            <div class="mb-3">
                <label for="answer" class="form-label"><strong>정답 <span class="text-danger">*</span></strong></label>
                <input type="text" class="form-control" id="answer" name="answer" value="{{ question.answer }}" required placeholder="객관식은 정답 보기 번호 (1-4), 주관식은 정답 텍스트">
                <small class="form-text text-muted">객관식 문제의 경우, 정답에 해당하는 보기의 번호(1, 2, 3, 또는 4)를 입력하세요.</small>
            </div>

            {# 문제 출처 #}
            <div class="mb-4">
                <label for="source_type" class="form-label"><strong>문제 출처 <span class="text-danger">*</span></strong></label>
                <select class="form-select" id="source_type" name="source_type" required>
                    <option value="manual_admin" {% if question.source_type == 'manual_admin' %}selected{% endif %}>관리자 수동 입력</option>
                    <option value="official_exam" {% if question.source_type == 'official_exam' %}selected{% endif %}>기출 문제</option>
                    <option value="ai_generated" {% if question.source_type == 'ai_generated' %}selected{% endif %}>AI 생성</option>
                </select>
            </div>

            <div class="d-flex justify-content-end">
                <a href="{{ url_for('admin.manage_questions', concept_id=question.concept.id) }}" class="btn btn-secondary me-2">취소</a>
                <button type="submit" class="btn btn-primary">수정 내용 저장</button>
            </div>
        </div>
    </div>
</form>
{% endblock %}