{# templates/student/my_page.html #}
{% extends "student/layout.html" %}

{% block title %}{{ user.username }}님의 마이 페이지{% endblock %}

{% block head_extra %}
<style>
    .trophy-icon { font-size: 3rem; color: #ffc107; margin-bottom: 0.5rem; }
    .points-badge { font-size: 0.8em; }
    .card-title { margin-bottom: 0.25rem; }
    .theme-selector .btn { margin: 5px; }
    .current-mascot-display {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #ddd;
        margin-bottom: 10px;
    }
    .mascot-option img {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 10px;
        border: 2px solid transparent;
        cursor: pointer;
        transition: border-color 0.3s ease;
    }
    .mascot-option img:hover, .mascot-option input[type="radio"]:checked + img {
        border-color: #007bff;
        box-shadow: 0 0 8px rgba(0,123,255,0.5);
    }
    .mascot-option input[type="radio"] {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-md-4">
            {# ★★★ 주석 제거 또는 Jinja2 주석으로 변경 ★★★ #}
            <div class="card mb-4">
                <div class="card-header text-center">
                    <h4>내 정보</h4>
                </div>
                <div class="card-body text-center">
                    {% if user.selected_mascot_filename %}
                        <img src="{{ url_for('static', filename='images/mascots/' + user.selected_mascot_filename) }}" alt="선택된 마스코트" class="current-mascot-display img-thumbnail">
                    {% else %}
                        <div class="current-mascot-display bg-light d-flex align-items-center justify-content-center text-muted">
                            <small>마스코트<br>선택 안 함</small>
                        </div>
                    {% endif %}
                    <p><strong>아이디:</strong> {{ user.username }}</p>
                    <p><strong>역할:</strong> {{ user.role }}</p>
                    <p><strong>총 획득 포인트:</strong> <span class="badge bg-success fs-5">{{ user.total_earned_points }} P</span></p>
                </div>
            </div>

            {# ... (나머지 포인트 사용 폼, 테마 변경 UI, 마스코트 변경 UI 등은 이전과 동일하게 유지) ... #}
            <div class="card mb-4">
                <div class="card-header">
                    <h4>포인트 사용하기 💰</h4>
                </div>
                <div class="card-body">
                    <p>현재 사용 가능 포인트: <strong class="fs-5 text-primary">{{ user.total_earned_points }} P</strong></p>
                    <form action="{{ url_for('student.use_points') }}" method="POST" class="row g-3 align-items-end">
                        <div class="col-sm-7">
                            <label for="points_to_use" class="form-label">사용할 포인트</label>
                            <input type="number" class="form-control" id="points_to_use" name="points_to_use" min="1" placeholder="예: 1000" required>
                        </div>
                        <div class="col-sm-5">
                            <button type="submit" class="btn btn-warning w-100">포인트 사용 요청</button>
                        </div>
                    </form>
                    <small class="form-text text-muted d-block mt-2">
                        (참고: 사용된 포인트는 관리자와의 약속에 따라 실제 용돈 등으로 교환될 수 있습니다.)
                    </small>
                </div>
            </div>

            <div class="card mb-4 theme-selector">
                <div class="card-header">
                    <h4>🎨 테마 변경</h4>
                </div>
                <div class="card-body text-center">
                    <p><small>학습 환경의 분위기를 바꿔보세요!</small></p>
                    <div class="btn-group" role="group" aria-label="Theme selection">
                        <a href="{{ url_for('student.set_theme', theme_name='theme-light-blue') }}" class="btn btn-outline-primary {% if session.get('user_theme', 'theme-light-blue') == 'theme-light-blue' %}active{% endif %}">기본 하늘</a>
                        <a href="{{ url_for('student.set_theme', theme_name='theme-fresh-green') }}" class="btn btn-outline-success {% if session.get('user_theme') == 'theme-fresh-green' %}active{% endif %}">상큼 초록</a>
                        <a href="{{ url_for('student.set_theme', theme_name='theme-warm-orange') }}" class="btn btn-outline-warning {% if session.get('user_theme') == 'theme-warm-orange' %}active{% endif %}">따뜻 주황</a>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <h4><i class="fas fa-paw me-2"></i>마스코트 변경</h4>
                </div>
                <div class="card-body">
                    <p><small>나를 대표할 마스코트를 선택해주세요!</small></p>
                    <form action="{{ url_for('student.set_mascot') }}" method="POST">
                        <div class="mb-3 d-flex flex-wrap justify-content-center">
                            {% for mascot_file in available_mascots %}
                                <label class="mascot-option m-2">
                                    <input type="radio" name="mascot_filename" value="{{ mascot_file }}" {% if user.selected_mascot_filename == mascot_file %}checked{% endif %} required>
                                    <img src="{{ url_for('static', filename='images/mascots/' + mascot_file) }}" alt="{{ mascot_file.split('.')[0] }}" class="img-thumbnail">
                                </label>
                            {% else %}
                                <p>선택 가능한 마스코트가 없습니다. 관리자에게 문의하세요.</p>
                            {% endfor %}
                        </div>
                        {% if available_mascots %}
                        <div class="d-grid">
                            <button type="submit" class="btn btn-info">마스코트 저장</button>
                        </div>
                        {% endif %}
                    </form>
                </div>
            </div>

        </div>
        <div class="col-md-8">
            <div class="card">
                <div class="card-header"><h4>내가 획득한 트로피 🏆</h4></div>
                <div class="card-body">
                    {% if earned_user_trophies %}
                        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3">
                            {% for user_trophy in earned_user_trophies %}
                            <div class="col">
                                <div class="card h-100 text-center">
                                    <div class="card-body d-flex flex-column justify-content-center align-items-center">
                                        <div class="my-2"><i class="{{ user_trophy.trophy.icon_class }} trophy-icon"></i></div>
                                        <h5 class="card-title">{{ user_trophy.trophy.name }}</h5>
                                        <span class="badge rounded-pill bg-warning text-dark points-badge mb-2">{{ user_trophy.trophy.points }} P</span>
                                        <p class="card-text"><small>{{ user_trophy.trophy.description }}</small></p>
                                    </div>
                                    <div class="card-footer"><small class="text-muted">획득: {{ user_trophy.earned_at.strftime('%Y년 %m월 %d일') }}</small></div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p>아직 획득한 트로피가 없습니다. 열심히 학습해서 트로피를 모아보세요!</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}