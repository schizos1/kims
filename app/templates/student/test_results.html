{% extends "student/layout.html" %}

{% block title %}{{ concept.name }} - 테스트 결과{% endblock %}

{% block head_extra %}
<style>
    .question-content, .submitted-answer-text, .correct-answer-text {
        white-space: pre-wrap; 
        line-height: 1.6;
    }
    .correct { color: green; font-weight: bold; }
    .incorrect { color: red; font-weight: bold; }
    
    .option-display { 
        padding: 0.375rem 0.75rem; 
        border-radius: 0.25rem; 
        display: block; 
        margin-bottom: 0.25rem;
        border: 1px solid #eee; /* 기본 테두리 */
    }
    .option-correct-answer { /* 실제 정답 보기 */
        background-color: #d1e7dd; /* 연한 초록색 배경 */
        border-color: #28a745; /* 진한 초록색 테두리 */
        font-weight: bold;
    }
    .option-user-correct { /* 사용자가 맞춘 보기 */
        border: 2px solid #198754; /* 초록색 굵은 테두리 */
        box-shadow: 0 0 5px rgba(40, 167, 69, 0.5);
    }
    .option-user-incorrect { /* 사용자가 틀리게 선택한 보기 */
        background-color: #f8d7da; /* 연한 빨강 배경 */
        border: 2px solid #dc3545; /* 빨간색 굵은 테두리 */
        text-decoration: line-through;
    }
</style>
{% endblock %}

{% block content %}
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('student.dashboard') }}">과목 목록</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('student.view_subject_concepts', subject_id=concept.subject.id) }}">{{ concept.subject.name }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ concept.name }} - 테스트 결과</li>
        </ol>
    </nav>

    <h2 class="mb-3">'{{ concept.name }}' 테스트 결과</h2>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                {% if category == 'info' %} 
                <div class="alert alert-success h4" role="alert">
                    {{ message }}
                </div>
                {% elif category == 'success' and '트로피' in message %}
                <div class="alert alert-success alert-dismissible fade show animated flash-success" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endif %}
            {% endfor %}
        {% endif %}
    {% endwith %}
    <p class="lead">총점: <strong>{{ score }}</strong></p>
    <hr>

    <h4 class="mb-3">상세 결과</h4>
    {% if results %}
        {% for result in results %}
        <div class="card mb-3">
            <div class="card-header">
                <strong>문제 {{ loop.index }}</strong> - 
                {% if result.is_correct %}
                    <span class="correct">정답입니다! 👍</span>
                {% else %}
                    <span class="incorrect">오답입니다. 😟</span>
                {% endif %}
            </div>
            <div class="card-body">
                <p class="card-text"><strong>문제:</strong></p>
                <pre class="question-content bg-light p-2 rounded mb-3">{{ result.question_content }}</pre>
                
               {# templates/student/test_results.html 내부 #}
                {% if result.question_obj.question_type == 'multiple_choice' %}
                    <p><strong>보기:</strong></p>
                    <ul class="list-unstyled">
                        {% set submitted_choice = result.submitted_answer | string %}
                        {% set correct_choice_num_str = result.correct_answer_num | string %}
                        
                        <li><span class="option-display 
                            {% if correct_choice_num_str == '1' %}option-correct-answer{% endif %}
                            {% if submitted_choice == '1' and result.is_correct %} option-user-correct
                            {% elif submitted_choice == '1' and not result.is_correct %} option-user-incorrect {% endif %}
                            {# ★★★ 수정된 부분 ★★★ #}
                            "><strong class="me-2">1.</strong> {{ result.question_obj.option1 }}</span></li>
                        <li><span class="option-display 
                            {% if correct_choice_num_str == '2' %}option-correct-answer{% endif %}
                            {% if submitted_choice == '2' and result.is_correct %} option-user-correct
                            {% elif submitted_choice == '2' and not result.is_correct %} option-user-incorrect {% endif %}
                            {# ★★★ 수정된 부분 ★★★ #}
                            "><strong class="me-2">2.</strong> {{ result.question_obj.option2 }}</span></li>
                        <li><span class="option-display 
                            {% if correct_choice_num_str == '3' %}option-correct-answer{% endif %}
                            {% if submitted_choice == '3' and result.is_correct %} option-user-correct
                            {% elif submitted_choice == '3' and not result.is_correct %} option-user-incorrect {% endif %}
                            {# ★★★ 수정된 부분 ★★★ #}
                            "><strong class="me-2">3.</strong> {{ result.question_obj.option3 }}</span></li>
                        <li><span class="option-display 
                            {% if correct_choice_num_str == '4' %}option-correct-answer{% endif %}
                            {% if submitted_choice == '4' and result.is_correct %} option-user-correct
                            {% elif submitted_choice == '4' and not result.is_correct %} option-user-incorrect {% endif %}
                            {# ★★★ 수정된 부분 ★★★ #}
                            "><strong class="me-2">4.</strong> {{ result.question_obj.option4 }}</span></li>
                    </ul>
                    <p class="mt-2"><strong>내가 선택한 답:</strong> {{ result.submitted_answer if result.submitted_answer else '선택 안 함' }}번</p>
                    <p><strong>정답:</strong> {{ result.correct_answer_num }}번</p>
                {% else %} 
                    {# ... (주관식 부분은 이전과 동일) ... #}
                {% endif %}
                
                {% if not result.is_correct %}
                <div class="mt-3">
                    <a href="{{ url_for('student.generate_similar_question_page', original_question_id=result.question_id) }}" class="btn btn-sm btn-warning">
                        🔄 같은 유형, 다른 문제 풀어보기
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="alert alert-warning">테스트 결과가 없습니다.</div>
    {% endif %}

    <div class="mt-4 d-flex justify-content-between">
        <a href="{{ url_for('student.view_subject_concepts', subject_id=concept.subject.id) }}" class="btn btn-secondary">&laquo; {{ concept.subject.name }} 개념 목록으로</a>
        <a href="{{ url_for('student.dashboard') }}" class="btn btn-primary">대시보드로 돌아가기 &raquo;</a>
    </div>
{% endblock %}