{% extends "student/layout.html" %}

{% block title %}{{ concept.name }} - í…ŒìŠ¤íŠ¸ ê²°ê³¼{% endblock %}

{% block head_extra %}
<style>
    .question-content, .submitted-answer-text, .correct-answer-text {
        white-space: pre-wrap; 
        line-height: 1.6;
    }
    .correct { color: green; font-weight: bold; }
    .incorrect { color: red; font-weight: bold; }
    
    .option-display { 
        padding: 0.375rem 0.75rem; 
        border-radius: 0.25rem; 
        display: block; 
        margin-bottom: 0.25rem;
        border: 1px solid #eee; /* ê¸°ë³¸ í…Œë‘ë¦¬ */
    }
    .option-correct-answer { /* ì‹¤ì œ ì •ë‹µ ë³´ê¸° */
        background-color: #d1e7dd; /* ì—°í•œ ì´ˆë¡ìƒ‰ ë°°ê²½ */
        border-color: #28a745; /* ì§„í•œ ì´ˆë¡ìƒ‰ í…Œë‘ë¦¬ */
        font-weight: bold;
    }
    .option-user-correct { /* ì‚¬ìš©ìê°€ ë§ì¶˜ ë³´ê¸° */
        border: 2px solid #198754; /* ì´ˆë¡ìƒ‰ êµµì€ í…Œë‘ë¦¬ */
        box-shadow: 0 0 5px rgba(40, 167, 69, 0.5);
    }
    .option-user-incorrect { /* ì‚¬ìš©ìê°€ í‹€ë¦¬ê²Œ ì„ íƒí•œ ë³´ê¸° */
        background-color: #f8d7da; /* ì—°í•œ ë¹¨ê°• ë°°ê²½ */
        border: 2px solid #dc3545; /* ë¹¨ê°„ìƒ‰ êµµì€ í…Œë‘ë¦¬ */
        text-decoration: line-through;
    }
</style>
{% endblock %}

{% block content %}
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('student.dashboard') }}">ê³¼ëª© ëª©ë¡</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('student.view_subject_concepts', subject_id=concept.subject.id) }}">{{ concept.subject.name }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ concept.name }} - í…ŒìŠ¤íŠ¸ ê²°ê³¼</li>
        </ol>
    </nav>

    <h2 class="mb-3">'{{ concept.name }}' í…ŒìŠ¤íŠ¸ ê²°ê³¼</h2>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                {% if category == 'info' %} 
                <div class="alert alert-success h4" role="alert">
                    {{ message }}
                </div>
                {% elif category == 'success' and 'íŠ¸ë¡œí”¼' in message %}
                <div class="alert alert-success alert-dismissible fade show animated flash-success" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endif %}
            {% endfor %}
        {% endif %}
    {% endwith %}
    <p class="lead">ì´ì : <strong>{{ score }}</strong></p>
    <hr>

    <h4 class="mb-3">ìƒì„¸ ê²°ê³¼</h4>
    {% if results %}
        {% for result in results %}
        <div class="card mb-3">
            <div class="card-header">
                <strong>ë¬¸ì œ {{ loop.index }}</strong> - 
                {% if result.is_correct %}
                    <span class="correct">ì •ë‹µì…ë‹ˆë‹¤! ğŸ‘</span>
                {% else %}
                    <span class="incorrect">ì˜¤ë‹µì…ë‹ˆë‹¤. ğŸ˜Ÿ</span>
                {% endif %}
            </div>
            <div class="card-body">
                <p class="card-text"><strong>ë¬¸ì œ:</strong></p>
                <pre class="question-content bg-light p-2 rounded mb-3">{{ result.question_content }}</pre>
                
               {# templates/student/test_results.html ë‚´ë¶€ #}
                {% if result.question_obj.question_type == 'multiple_choice' %}
                    <p><strong>ë³´ê¸°:</strong></p>
                    <ul class="list-unstyled">
                        {% set submitted_choice = result.submitted_answer | string %}
                        {% set correct_choice_num_str = result.correct_answer_num | string %}
                        
                        <li><span class="option-display 
                            {% if correct_choice_num_str == '1' %}option-correct-answer{% endif %}
                            {% if submitted_choice == '1' and result.is_correct %} option-user-correct
                            {% elif submitted_choice == '1' and not result.is_correct %} option-user-incorrect {% endif %}
                            {# â˜…â˜…â˜… ìˆ˜ì •ëœ ë¶€ë¶„ â˜…â˜…â˜… #}
                            "><strong class="me-2">1.</strong> {{ result.question_obj.option1 }}</span></li>
                        <li><span class="option-display 
                            {% if correct_choice_num_str == '2' %}option-correct-answer{% endif %}
                            {% if submitted_choice == '2' and result.is_correct %} option-user-correct
                            {% elif submitted_choice == '2' and not result.is_correct %} option-user-incorrect {% endif %}
                            {# â˜…â˜…â˜… ìˆ˜ì •ëœ ë¶€ë¶„ â˜…â˜…â˜… #}
                            "><strong class="me-2">2.</strong> {{ result.question_obj.option2 }}</span></li>
                        <li><span class="option-display 
                            {% if correct_choice_num_str == '3' %}option-correct-answer{% endif %}
                            {% if submitted_choice == '3' and result.is_correct %} option-user-correct
                            {% elif submitted_choice == '3' and not result.is_correct %} option-user-incorrect {% endif %}
                            {# â˜…â˜…â˜… ìˆ˜ì •ëœ ë¶€ë¶„ â˜…â˜…â˜… #}
                            "><strong class="me-2">3.</strong> {{ result.question_obj.option3 }}</span></li>
                        <li><span class="option-display 
                            {% if correct_choice_num_str == '4' %}option-correct-answer{% endif %}
                            {% if submitted_choice == '4' and result.is_correct %} option-user-correct
                            {% elif submitted_choice == '4' and not result.is_correct %} option-user-incorrect {% endif %}
                            {# â˜…â˜…â˜… ìˆ˜ì •ëœ ë¶€ë¶„ â˜…â˜…â˜… #}
                            "><strong class="me-2">4.</strong> {{ result.question_obj.option4 }}</span></li>
                    </ul>
                    <p class="mt-2"><strong>ë‚´ê°€ ì„ íƒí•œ ë‹µ:</strong> {{ result.submitted_answer if result.submitted_answer else 'ì„ íƒ ì•ˆ í•¨' }}ë²ˆ</p>
                    <p><strong>ì •ë‹µ:</strong> {{ result.correct_answer_num }}ë²ˆ</p>
                {% else %} 
                    {# ... (ì£¼ê´€ì‹ ë¶€ë¶„ì€ ì´ì „ê³¼ ë™ì¼) ... #}
                {% endif %}
                
                {% if not result.is_correct %}
                <div class="mt-3">
                    <a href="{{ url_for('student.generate_similar_question_page', original_question_id=result.question_id) }}" class="btn btn-sm btn-warning">
                        ğŸ”„ ê°™ì€ ìœ í˜•, ë‹¤ë¥¸ ë¬¸ì œ í’€ì–´ë³´ê¸°
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="alert alert-warning">í…ŒìŠ¤íŠ¸ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
    {% endif %}

    <div class="mt-4 d-flex justify-content-between">
        <a href="{{ url_for('student.view_subject_concepts', subject_id=concept.subject.id) }}" class="btn btn-secondary">&laquo; {{ concept.subject.name }} ê°œë… ëª©ë¡ìœ¼ë¡œ</a>
        <a href="{{ url_for('student.dashboard') }}" class="btn btn-primary">ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸° &raquo;</a>
    </div>
{% endblock %}