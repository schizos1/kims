{% extends "base.html" %}
{% load static %}

{% block title %}
    ì˜¤ë‹µ ë‹¤ì‹œ í’€ê¸° - 
    {% if subject and lesson %}{{ subject.name }} - {{ lesson.unit_name }}
    {% elif subject %}{{ subject.name }} - (ë‹¨ì› ì—†ìŒ)
    {% else %}ì˜¤ë‹µ ë¬¸ì œ
    {% endif %}
{% endblock %}

{% block extra_head %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
<style>
    /* ... (ì´ì „ê³¼ ë™ì¼í•œ í˜ì´ì§€ íŠ¹ì • CSS ìŠ¤íƒ€ì¼ë“¤) ... */
    .page-title-container { /* í˜ì´ì§€ ì œëª©ì„ ìœ„í•œ ì»¨í…Œì´ë„ˆ */
        text-align: center;
        margin-bottom: 1.5em; /* ê¸°ì¡´ë³´ë‹¤ ë§ˆì§„ ì¤„ì„ */
        padding-top: 1em;
    }
    .page-title-decorated { /* dashboard_styles.css ì— ì´ë¯¸ ì •ì˜ë˜ì–´ ìˆë‹¤ë©´ ì—¬ê¸°ì„œ ì¤‘ë³µ ì •ì˜ ë¶ˆí•„ìš” */
        display: inline-block;
        background: linear-gradient(90deg,#ffcdd2,#b2ebf2,#fff59d); /* ìƒ‰ìƒ ë³€ê²½ (í•‘í¬-ë¯¼íŠ¸-ë…¸ë‘) */
        border-radius: 2em; 
        padding:0.3em 1.2em 0.45em 1.2em; 
        box-shadow:0 6px 20px rgba(0,0,0,0.07);
        font-size: 1.8rem; /* í¬ê¸° ì‚´ì§ ì¤„ì„ */
        font-weight: 700;
        color: #546e7a; 
        letter-spacing:0.5px;
    }

    .quiz-card { /* ë¬¸ì œ ì¹´ë“œë¥¼ ìœ„í•œ ìƒˆë¡œìš´ í´ë˜ìŠ¤ */
        background: #ffffff;
        border-radius: 18px;
        padding: 2em;
        margin-bottom: 1.8em;
        box-shadow: 0 8px 25px rgba(0, 80, 160, 0.1);
        border: 1px solid #e0eafc;
    }
    .quiz-card .card-title-custom { /* Bootstrap .card-titleê³¼ êµ¬ë¶„ */
        color: #3a7bd5; /* ëŒ€ì‹œë³´ë“œ ì œëª©ê³¼ ìœ ì‚¬í•œ ìƒ‰ìƒ */
        font-weight: 700;
        font-size: 1.3em;
        margin-bottom: 1em;
        border-bottom: 2px solid #e0eafc;
        padding-bottom: 0.5em;
    }
    .quiz-card .card-text {
        font-size: 1.05em;
        line-height: 1.7;
        color: #37474f;
        margin-bottom: 1.5em;
    }
    .quiz-card .form-check {
        margin-bottom: 0.8em;
        padding: 0.75em 1em;
        border-radius: 12px;
        background-color: #f8f9fa;
        transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        cursor: pointer;
    }
    .quiz-card .form-check:hover {
        background-color: #e9ecef;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .quiz-card .form-check-input {
        margin-top: 0.4em; /* ë¼ë²¨ê³¼ ì •ë ¬ */
    }
    .quiz-card .form-check-label {
        font-weight: 500;
        color: #495057;
        cursor: pointer;
        width: 100%; /* ë¼ë²¨ ì „ì²´ í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡ */
    }
    .quiz-card .form-check-input:checked + .form-check-label {
        color: #007bff; /* ì„ íƒ ì‹œ ë¼ë²¨ ìƒ‰ìƒ ë³€ê²½ */
        font-weight: 700;
    }
    .quiz-card .img-fluid { /* ì„ íƒì§€ ì´ë¯¸ì§€ í¬ê¸° ì œí•œ */
        max-height: 80px; /* ì´ë¯¸ì§€ ìµœëŒ€ ë†’ì´ */
        margin-left: 10px;
        border-radius: 8px;
        border: 1px solid #ddd;
    }

    .submit-button-container {
        text-align: center;
        margin-top: 2em;
    }
    .btn-submit-quiz { /* ë‹µì•ˆ ì œì¶œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-weight: 600;
        padding: 0.8em 2.5em;
        border-radius: 50px;
        font-size: 1.1em;
        transition: all 0.3s ease;
        border: none;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.35);
    }
    .btn-submit-quiz:hover {
        background: linear-gradient(135deg, #5a6fdd 0%, #623aa0 100%);
        transform: translateY(-2px);
        box-shadow: 0 7px 20px rgba(102, 126, 234, 0.45);
    }

    /* ëª¨ë“  ì˜¤ë‹µ í•´ê²° ì‹œ/ë¬¸ì œ ì—†ì„ ì‹œ ë©”ì‹œì§€ ë°•ìŠ¤ */
    .feedback-box { /* .alert í´ë˜ìŠ¤ì™€ í•¨ê»˜ ì‚¬ìš© */
        padding: 1.5em;
        border-radius: 15px;
        margin-top: 1em;
    }
    .feedback-box h4 {
        font-weight: 700;
        margin-bottom: 0.5em;
    }
    .feedback-box .btn {
        font-weight: 600;
        margin: 0.5em;
        padding: 0.6em 1.2em;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">

    <div class="page-title-container">
        <h2 class="page-title-decorated">
            ğŸ“ 
            {% if subject and lesson %}
                {{ subject.name }} - {{ lesson.unit_name }} ì˜¤ë‹µ ë‹¤ì‹œ í’€ê¸°
            {% elif subject %}
                {{ subject.name }} - (ë‹¨ì› ì—†ìŒ) ì˜¤ë‹µ ë‹¤ì‹œ í’€ê¸°
            {% else %}
                ì˜¤ë‹µ ë‹¤ì‹œ í’€ê¸°
            {% endif %}
        </h2>
    </div>

    {% if all_corrected %}
        <div class="alert alert-success text-center feedback-box animate__animated animate__tada" role="alert">
            <h4>ğŸ‰ ëª¨ë“  ì˜¤ë‹µ ë¬¸ì œë¥¼ í•´ê²°í–ˆìŠµë‹ˆë‹¤! ğŸ‰</h4>
            <p class="mb-3">ë‹¤ë¥¸ ë‹¨ì›ì˜ ì˜¤ë‹µì„ í™•ì¸í•˜ê±°ë‚˜, ìƒˆë¡œìš´ ë¬¸ì œë¥¼ í’€ì–´ë³´ì„¸ìš”.</p>
            <a href="{% url 'quiz:wrong_note_list' %}" class="btn btn-info rounded-pill">ì˜¤ë‹µë…¸íŠ¸ ëª©ë¡ìœ¼ë¡œ</a>
            <a href="{% url 'quiz:concept_select' %}" class="btn btn-primary rounded-pill">ë‹¤ë¥¸ ë¬¸ì œ í’€ëŸ¬ê°€ê¸°</a>
        </div>
    {% elif questions %}
        {# í¼ ì•¡ì…˜ URLì—ì„œ lesson.idê°€ Noneì¼ ê²½ìš° '0' ì „ë‹¬ (ë·°ì—ì„œ ì´ '0'ì„ ì²˜ë¦¬í•´ì•¼ í•¨) #}
        <form method="post" action="{% url 'quiz:wrong_note_quiz' subject_id=subject.id lesson_id=lesson.id|default_if_none:'0' %}">
            {% csrf_token %}
            {% for question in questions %}
                <div class="quiz-card animate__animated animate__fadeInUp mb-4">
                    <h5 class="card-title-custom">
                        ë¬¸ì œ {{ forloop.counter }}
                        {% if is_retry_page %} (ì¬ë„ì „) {% endif %}
                    </h5>
                    <div class="card-text question-text">{{ question.text|linebreaksbr }}</div>
                    {% if question.image %}
                        <img src="{{ question.image }}" alt="ë¬¸ì œ ì´ë¯¸ì§€" class="img-fluid mb-3" style="max-width: 300px; border-radius: 8px;">
                    {% endif %}
                    
                    <div class="choices-container mt-3">
                        {# === ì„ íƒì§€ ìˆ˜ì •: getattr í•„í„° ëŒ€ì‹  ì§ì ‘ í•„ë“œëª… ì‚¬ìš© === #}
                        {% if question.choice1_text %}
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="q_{{ question.id }}" id="choice{{ question.id }}_1" value="1" required>
                            <label class="form-check-label" for="choice{{ question.id }}_1">
                                {{ question.choice1_text }}
                                {% if question.choice1_image %}
                                    <img src="{{ question.choice1_image }}" alt="ì„ íƒì§€1 ì´ë¯¸ì§€" class="img-fluid">
                                {% endif %}
                            </label>
                        </div>
                        {% endif %}
                        {% if question.choice2_text %}
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="q_{{ question.id }}" id="choice{{ question.id }}_2" value="2" required>
                            <label class="form-check-label" for="choice{{ question.id }}_2">
                                {{ question.choice2_text }}
                                {% if question.choice2_image %}
                                    <img src="{{ question.choice2_image }}" alt="ì„ íƒì§€2 ì´ë¯¸ì§€" class="img-fluid">
                                {% endif %}
                            </label>
                        </div>
                        {% endif %}
                        {% if question.choice3_text %}
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="q_{{ question.id }}" id="choice{{ question.id }}_3" value="3" required>
                            <label class="form-check-label" for="choice{{ question.id }}_3">
                                {{ question.choice3_text }}
                                {% if question.choice3_image %}
                                    <img src="{{ question.choice3_image }}" alt="ì„ íƒì§€3 ì´ë¯¸ì§€" class="img-fluid">
                                {% endif %}
                            </label>
                        </div>
                        {% endif %}
                        {% if question.choice4_text %}
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="q_{{ question.id }}" id="choice{{ question.id }}_4" value="4" required>
                            <label class="form-check-label" for="choice{{ question.id }}_4">
                                {{ question.choice4_text }}
                                {% if question.choice4_image %}
                                    <img src="{{ question.choice4_image }}" alt="ì„ íƒì§€4 ì´ë¯¸ì§€" class="img-fluid">
                                {% endif %}
                            </label>
                        </div>
                        {% endif %}
                        {# === ì„ íƒì§€ ìˆ˜ì • ë === #}
                    </div>
                </div>
            {% endfor %}
            <div class="submit-button-container">
                <button type="submit" class="btn btn-submit-quiz rounded-pill">
                    <i class="fas fa-paper-plane me-2"></i> ë‹µì•ˆ ì œì¶œí•˜ê¸°
                </button>
            </div>
        </form>
    {% elif is_retry_page and not questions %}
        <div class="alert alert-warning text-center feedback-box" role="alert">
            ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. <a href="{% url 'quiz:wrong_note_list' %}" class="alert-link">ì˜¤ë‹µë…¸íŠ¸ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>.
        </div>
    {% else %}
        <div class="alert alert-info text-center feedback-box" role="alert">
            <p>ì´ ë‹¨ì›ì—ëŠ” í˜„ì¬ ë‹¤ì‹œ í’€ ì˜¤ë‹µ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            <a href="{% url 'quiz:wrong_note_list' %}" class="btn btn-secondary mt-2 rounded-pill">ì˜¤ë‹µë…¸íŠ¸ ëª©ë¡ìœ¼ë¡œ</a>
        </div>
    {% endif %}

    {% if not all_corrected %}
    <div style="text-align: center; margin-top: 3em; margin-bottom: 1em;">
        <a href="{% url 'users:student_dashboard' %}" class="menu-item fancy-button" 
           style="width: 200px; background: linear-gradient(135deg, #a8d1ff, #6c92be);"
           data-sound-hover="default-hover" data-sound-click="default-click">
           <span class="menu-icon" style="font-size: 1.2em;"><i class="fas fa-arrow-left"></i></span>
           <span class="menu-text" style="font-size: 1em;">ëŒ€ì‹œë³´ë“œë¡œ</span>
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
{# ì´ í˜ì´ì§€ ì „ìš© JavaScript (ì˜ˆ: ì„ íƒì§€ í´ë¦­ ì‹œ íš¨ê³¼ ë“±) #}
{% endblock %}